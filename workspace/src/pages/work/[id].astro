---
import dotenv from 'dotenv';
import { WorkRepository } from '../../_repositories/work/repository';
import { WorkDataMap } from "../../_models/work/mapper";
import Head from "../../_components/ui/layout/head.astro"
import Seo from "../../_components/ui/layout/seo.astro"
import WorkSingle from "../../_components/page/work.$id"

dotenv.config();

export async function getStaticPaths() {
  const repository = WorkRepository.create(process.env.API_KEY);
  const result = await repository.findAll();
  const posts = result.works.map(WorkDataMap.toDTO);
  const first = posts[0];
  const last = posts[posts.length - 1];

  return posts.map((post, index) => ({
    params: {
      id: post.id,
    },
    props: {
      posts,
      post,
      prev: first.id === post.id ? last : posts[index - 1],
      next: last.id === post.id ? first : posts[index + 1],
      total: result.totalCount,
      currentIndex: index + 1,
    },
  }))
}

const { posts, post, next, total, currentIndex } = Astro.props;

---

<Head>
  <Seo title={post.name} url={`/${post.id}/`} />
</Head>
<WorkSingle posts={posts} post={post} currentIndex={currentIndex} />
