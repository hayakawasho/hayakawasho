---
import dotenv from 'dotenv';
import WorkSingle from '../../_components/page/work-single';
import { IMG_API, BREAK_POINTS } from '../../_foundation/const';
import DefalutLayout from "../../layout.astro";
import { createWorkRepository } from '../../_repositories/works';

dotenv.config();

export async function getStaticPaths() {
  const workRepo = createWorkRepository(process.env.API_KEY);
  const result = await workRepo.findList({
    limit: 99,
    orders: '-launch',
  });

  const { works } = result
  const last = works[works.length - 1]

  return works.map((item, index) => ({
    params: {
      slug: item.id,
    },
    props: {
      post: item,
      next: last.id === item.id ? works[0] : works[index + 1],
      totalCount: result.totalCount,
      currentIndex: index + 1
    },
  }));
}

const { post, next, totalCount, currentIndex } = Astro.props;

---

<DefalutLayout title={post.title} permalink={`/work/${post.id}/`} namespace="work-single">
  <link
    slot="prependHead"
    as="image"
    crossorigin="anonymous"
    href={post.mv.src + IMG_API + '&w=640'}
    media={BREAK_POINTS['sp']}
    rel="preload"
  />
  <link
    slot="prependHead"
    as="image"
    crossorigin="anonymous"
    href={post.mv.src + IMG_API + '&w=1440'}
    media={BREAK_POINTS['pc']}
    rel="preload"
  />
  <WorkSingle post={post} nextPost={next} now={currentIndex} max={totalCount} />
</DefalutLayout>
